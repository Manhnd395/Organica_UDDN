name: CI - Test, Build & Update Manifests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  packages: write

jobs:
  test:
    name: Run tests
    runs-on: ubuntu-latest
    services:
      mongo:
        image: mongo:6
        ports: 
          - 27017:27017
        options: >-
          --health-cmd="mongosh --quiet --eval 'db.runCommand({ping:1})'"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests (if any)
        env:
          MONGO_URL: mongodb://localhost:27017
          MONGO_DB_NAME: organica_ci
        run: |
          if npm run -s | grep -q '^test'; then
            npm test;
          else
            echo "No test script defined";
          fi

  build-and-push:
    name: Build and push to GHCR
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ghcr.io/${{ github.repository }}/organica:latest
            ghcr.io/${{ github.repository }}/organica:${{ github.sha }}

      - name: Update kustomization.yaml with new image tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          KUSTOMIZE_FILE="k8s/overlays/production/kustomization.yaml"
          NEW_TAG="${{ github.sha }}"
          
          if [ -f "$KUSTOMIZE_FILE" ]; then
            sed -i "s|newTag: .*|newTag: \"${NEW_TAG}\"|" "$KUSTOMIZE_FILE"
            sed -i "s|name: gcr.io/.*/organica|name: ghcr.io/${{ github.repository }}/organica|" "$KUSTOMIZE_FILE"
            
            git add "$KUSTOMIZE_FILE"
            if git diff --staged --quiet; then
              echo "No changes to commit"
            else
              git commit -m "ci: update image tag to ${NEW_TAG}"
              git push
            fi
          else
            echo "Kustomize file not found: $KUSTOMIZE_FILE"
            exit 1
          fi
