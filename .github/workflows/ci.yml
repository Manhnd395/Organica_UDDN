name: CI - Test, Build & Update Manifests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  packages: write

jobs:
  test:
    name: Run tests
    runs-on: ubuntu-latest
    services:
      mongo:
        image: mongo:6
        ports: 
          - 27017:27017
        options: >-
          --health-cmd="mongosh --quiet --eval 'db.runCommand({ping:1})'"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests (if any)
        env:
          MONGO_URL: mongodb://localhost:27017
          MONGO_DB_NAME: organica_ci
        run: |
          if npm run -s | grep -q '^test'; then
            npm test;
          else
            echo "No test script defined";
          fi

  build-and-push:
    name: Build and push to GHCR
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    env:
      REGISTRY: ghcr.io
      IMAGE_NAME: organica
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix=sha-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  deploy-secrets:
    name: Deploy Secrets to Kubernetes
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ secrets.GKE_CLUSTER_NAME }}
          location: ${{ secrets.GKE_ZONE }}

      - name: Create/Update Kubernetes Secrets
        run: |
          kubectl create namespace production --dry-run=client -o yaml | kubectl apply -f -
          
          kubectl create secret generic organica-secrets \
            --namespace=production \
            --from-literal=GOOGLE_CLIENT_ID='${{ secrets.GOOGLE_CLIENT_ID }}' \
            --from-literal=GOOGLE_CLIENT_SECRET='${{ secrets.GOOGLE_CLIENT_SECRET }}' \
            --from-literal=GEMINI_API_KEY='${{ secrets.GEMINI_API_KEY }}' \
            --from-literal=MONGO_URL='${{ secrets.MONGO_URL }}' \
            --from-literal=DB_NAME='organica' \
            --from-literal=JWT_SECRET='${{ secrets.JWT_SECRET }}' \
            --from-literal=SESSION_SECRET='${{ secrets.SESSION_SECRET }}' \
            --dry-run=client -o yaml | kubectl apply -f -
          
          echo "âœ… Secrets deployed successfully!"

  update-manifests:
    name: Update Kustomize Manifests
    needs: deploy-secrets
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update kustomization.yaml with new image tag
        env:
          REGISTRY: ghcr.io
          IMAGE_NAME: organica
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          KUSTOMIZE_FILE="k8s/overlays/production/kustomization.yaml"
          NEW_TAG="sha-${{ github.sha }}"
          IMAGE_FULL_NAME="${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}"
          
          if [ -f "$KUSTOMIZE_FILE" ]; then
            sed -i "s|newTag: .*|newTag: \"${NEW_TAG}\"|" "$KUSTOMIZE_FILE"
            sed -i "s|name: .*|name: ${IMAGE_FULL_NAME}|" "$KUSTOMIZE_FILE"
            
            git add "$KUSTOMIZE_FILE"
            if git diff --staged --quiet; then
              echo "No changes to commit"
            else
              git commit -m "ci: update image tag to ${NEW_TAG}"
              git push
            fi
          else
            echo "Kustomize file not found: $KUSTOMIZE_FILE"
            exit 1
          fi
