name: CI - Build & Push Docker Image

on:
  push:
    branches: [ main ]
  pull_request:
    name: CI - Test, Build & Push Docker Image

    on:
      push:
        branches: [ main ]
      pull_request:
        branches: [ main ]
      workflow_dispatch:

    concurrency:
      group: ci-${{ github.ref }}
      cancel-in-progress: true

    permissions:
      contents: read
      packages: write

    jobs:
      test:
        name: Run tests (Node)
        runs-on: ubuntu-latest
        services:
          mongo:
            image: mongo:6
            ports: ["27017:27017"]
            options: >-
              --health-cmd="mongosh --quiet --eval 'db.runCommand({ ping: 1 })'"
              --health-interval=10s --health-timeout=5s --health-retries=5
        strategy:
          matrix:
            node-version: [18.x]
        steps:
          - name: Checkout
            uses: actions/checkout@v4

          - name: Setup Node.js
            uses: actions/setup-node@v4
            with:
              node-version: ${{ matrix.node-version }}
              cache: 'npm'

          - name: Install dependencies
            run: npm ci

          - name: Run tests (if any)
            env:
              MONGO_URL: mongodb://localhost:27017
              MONGO_DB_NAME: organica_ci
            run: |
              if npm run -s | grep -q '^test'; then
                npm test;
              else
                echo "No test script defined";
              fi

      build-and-push:
        name: Build and push Docker image
        needs: test
        runs-on: ubuntu-latest
        steps:
          - name: Checkout
            uses: actions/checkout@v4

          - name: Log in to GitHub Container Registry
            uses: docker/login-action@v3
            with:
              registry: ghcr.io
              username: ${{ github.actor }}
              password: ${{ secrets.GITHUB_TOKEN }}

          - name: Build and push Docker image
            uses: docker/build-push-action@v6
            with:
              context: .
              push: true
              tags: ghcr.io/${{ github.repository }}/organica:latest
